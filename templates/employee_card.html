{% extends "base.html" %}

{% block content %}
    <div class="row-fluid">
        <div class="span10">
            <h1 id ="title" class="well">Информация о сотруднике #{{ data.object.general.id }}</h1>
        </div>
        <div class="span2"></div>
    </div>
    <div class="row-fluid">
        <div id="pic" class="span3 well" style="min-width: 250px;"> 
            <div style="width: 200px; height: 300px; background: #aab; margin-left: auto; margin-right: auto;"></div>
            <div><strong>Должность:</strong> {{ data.object.general.role }}</div>
            {% if data.meta.is_technic %} <span class="label label-info">Есть права техника</span> {% endif %}
            {% if data.meta.is_admin   %} <span class="label label-success">Есть права администратора</span> {% endif %}
        </div>
        <div id="info" class="span7">
            <div class="well">
                <h3>Анкета</h3>
                <dl class="well dl-horizontal" style="background-color:#DDD">
                    <dt>Полное имя:</dt>  <dd>{{ data.object.general.name }}</dd>
                    <dt>СНИЛС:</dt>       <dd>{{ data.object.general.snils }}</dd>
                    <dt>Логин:</dt>       <dd>{{ data.object.general.login }}</dd>
                    <dt>Телефон:</dt>     <dd>{{ data.object.general.phone }}</dd>
                    <dt>Адрес:</dt>       <dd>{{ data.object.general.addr }}</dd>
                </dl>
            </div>
            <div class="well">
                <h3>Список операций</h3>
                <dl class="well dl-horizontal" style="background-color:#DDD">
                    {% for op in data.object.operations %}
                    <dt>{{ op.type }}:</dt>  <dd>{{ op.date }}</dd>
                    {% endfor %}
                </dl>
            </div>
            <div class="well" id="equipment_list">
                <h3 id='equipment-toggle'>Используемое оборудование</h3>
                {% for eq in data.object.owner_of %}
                <div class="well dl-horizontal {% if not eq.actual %}extra-equipment{%endif %}" style="background-color:#DDD;">
                    <dt>ID:</dt>                        <dd>{{ eq.equipment.id }}</dd>
                    <dt>Название:</dt>                  <dd>{{ eq.equipment.name }}</dd>
                    <dt>Местоположение:</dt>            <dd>{{ eq.equipment.addr }}</dd>
                    <dt>Серийный номер:</dt>            <dd>{{ eq.equipment.serial_number }}</dd>
                    <dt>Начало эксплуатации:</dt>       <dd>{{ eq.date_begin }}</dd>
                    <dt>Завершение эксплуатации:</dt>   <dd>{{ eq.date_end }}</dd>
                </div>
                {% endfor %}
            </div>            
            <div class="well">
                <h3>Задачи, инициированные сотрудником</h3>
                {% for t in data.object.tasks %}
                <div class="well dl-horizontal" style="background-color:#DDD" onclick="loadEquipment({{t.id}});">
                    <dt>ID:</dt>                    <dd>{{ t.id }}</dd>
                    <dt>Время регистрации:</dt>     <dd>{{ t.datetime }}</dd>
                    <dt>Название задачи:</dt>       <dd>{{ t.name }}</dd>
                    <dt>Ответственный техник:</dt>  <dd onclick="window.location='{{ t.owner.resource_uri }}'">{{ t.owner.name }}</dd>
                    <div id="task-equipment-{{ t.id }}" class="task-equipment"></div>
                </div>
                {% endfor %}
            </div>
            <div class="well">
                <h3>Новая задача</h3>
            </div>
            <div class="well">
                <h3>Задачи и оборудование</h3>
                <input id="task-id" type="text" placeholder="ID задачи" style="width: 100px">
                <input id="equipment-id" type="text" placeholder="ID оборудования" style="width: 100px">
                <button class="btn" type="button" onclick="addEquipmentToTask();">Прикрепить</button>
                <button class="btn" type="button" onclick="removeEquipmentFromTask();">Открепить</button>
            </div>
        </div>
    </div>
{% endblock content %}

{% block userscript %}
<script>
    function uri_to_addr( uri ) {
        return "/api" + uri;
    }

    $('#equipment-toggle').click(function(){
        $('.extra-equipment').toggle()
    });
    
    function build_equipment_for_task(json) {
        return  '<div class="well dl-horizontal">'
              + '    <dt>ID:</dt>                        <dd> ' + json.id + ' </dd>'
              + '    <dt>Название:</dt>                  <dd> ' + json.name + ' </dd>'
              + '    <dt>Местоположение:</dt>            <dd> ' + json.addr + ' </dd>'
              + '    <dt>Серийный номер:</dt>            <dd> ' + json.serial_number + '</dd>'
              + '</div>'
    }    
    
    function loadEquipment(task_id) {
        place = '#task-equipment-' + task_id;
        uri = '/task/' + task_id + '/equipment/';
        $.getJSON(uri_to_addr(uri), {}, function(json) {
            $(place).empty();
            $.each(json, function(){
                $(place).append(build_equipment_for_task(this));
            });
        });
    }
    
    function addEquipmentToTask() {
        task_id = $('#task-id').val();
        equipment_id = $('#equipment-id').val();
        uri = '/task/' + task_id + '/equipment/' + equipment_id + '/';
        $('#task-id').addClass('btn-danger');
        $.post(uri_to_addr(uri), {}).done(function() { 
            $('#task-id').removeClass('btn-danger');
        });
    }

    function removeEquipmentFromTask() {
        task_id = $('#task-id').val();
        equipment_id = $('#equipment-id').val();
        uri = '/task/' + task_id + '/equipment/' + equipment_id + '/';
        $('#task-id').addClass('btn-danger');
        $.ajax(uri_to_addr(uri), {type:'DELETE'}).done(function() { 
            $('#task-id').removeClass('btn-danger');
        });
    }

    window.onresize = function(event) {
        if ( window.innerWidth >= 768 ) {
            $('#title').width(
                          $('#pic') .width() + 
                          $('#info').width() +
                parseInt( $('#info').css('margin-left').replace("px", ""))
            );
        } else {
            $('#title').width( $('#navbar').width() - 80 );
        }
    }
    
    window.onload = window.onresize;
    $('.extra-equipment').hide();
</script>
{% endblock userscript %}
